<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARIS-Advanced Research Innovative Solution</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eff6ff',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
            }
          }
        }
      }
    }
  </script>
  <style>
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .chat-box { 
      max-height: 400px; 
      overflow-y: auto; 
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }
    .chat-box::-webkit-scrollbar {
      width: 6px;
    }
    .chat-box::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }
    .chat-box::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    /* 3D Viewer Styles */
    #viewer-container-3d {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      display: none;
      flex-direction: column;
    }
    #viewer-3d {
      flex: 1;
      width: 100%;
    }
    #viewer-header {
      padding: 1rem;
      background: #1a202c;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #close-viewer {
      background: #e53e3e;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      cursor: pointer;
    }
    #close-viewer:hover {
      background: #c53030;
    }
    .message { 
      margin: .5rem 0; 
      padding: .75rem 1rem; 
      border-radius: 1rem; 
      max-width: 85%; 
      word-wrap: break-word;
      animation: fadeInUp 0.3s ease-out;
    }
    .user { 
      background: linear-gradient(135deg, #3b82f6, #1d4ed8); 
      color: white; 
      margin-left: auto; 
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    .bot { 
      background: #f8fafc; 
      color: #1e293b; 
      margin-right: auto; 
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .tab { display: none; }
    .tab.active { display: block; }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .paper-card {
      transition: all 0.3s ease;
      transform: translateY(0);
    }
    .paper-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .search-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
  </style>
</head>
<body class="font-sans text-gray-800">
  <!-- Header -->
  <div class="text-center py-8">
    <div class="flex justify-between items-center px-6 mb-4">
      <div class="inline-flex items-center space-x-3">
        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">
        <i class="fas fa-brain text-2xl text-blue-600"></i>
        </div>
        <h1 class="text-4xl font-bold text-white">ARIS</h1>
      </div>
      <a href="/notebook" class="bg-white text-primary-600 hover:bg-gray-100 px-6 py-2 rounded-full font-medium shadow-md transition duration-200 flex items-center space-x-2">
        <i class="fas fa-book-open"></i>
        <span>Research Notebook</span>
      </a>
    </div>
    <p class="text-white/90 text-lg max-w-2xl mx-auto">
      AI-Powered Research Assistant ‚Ä¢ Discover ‚Ä¢ Analyze ‚Ä¢ Transform
    </p>
  </div>

  <!-- Search Section -->
  <div class="max-w-4xl mx-auto px-6 mb-8">
    <div class="search-container rounded-2xl p-8 text-center">
      <div class="max-w-2xl mx-auto">
        <h2 class="text-2xl font-semibold text-white mb-4">Find Research Papers</h2>
        <p class="text-white/80 mb-6">Search through 250M+ research papers with AI-powered semantic understanding</p>
        
        <div class="flex gap-3 mb-4">
          <div class="flex-1 relative">
            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input 
              id="query" 
              class="w-full pl-12 pr-4 py-4 rounded-xl border-0 text-lg focus:ring-4 focus:ring-blue-300 focus:outline-none" 
              placeholder="Search papers (e.g., quantum computing, machine learning, climate change)..." 
              onkeypress="if(event.key==='Enter') searchPapers()"
            />
          </div>
          <button 
            onclick="searchPapers()" 
            id="searchBtn"
            class="px-8 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center gap-2"
          >
            <i class="fas fa-search"></i>
            Search
          </button>
        </div>
        
        <div class="flex flex-wrap gap-2 justify-center text-sm text-white/80">
          <span class="px-3 py-1 bg-white/20 rounded-full">Semantic Search</span>
          <span class="px-3 py-1 bg-white/20 rounded-full">AI Analysis</span>
          <span class="px-3 py-1 bg-white/20 rounded-full">Multi-level Summaries</span>
          <span class="px-3 py-1 bg-white/20 rounded-full">Interactive Chat</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div id="results" class="max-w-6xl mx-auto px-6 space-y-6"></div>

  <!-- Loading State -->
  <div id="loading" class="hidden text-center py-12">
    <div class="loading mx-auto mb-4"></div>
    <p class="text-white/80">Searching through research papers...</p>
  </div>

  <!-- No Results State -->
  <div id="noResults" class="hidden text-center py-12">
    <i class="fas fa-search text-4xl text-white/60 mb-4"></i>
    <p class="text-white/80 text-lg">No papers found. Try different keywords or check your spelling.</p>
  </div>

  <script>
    let currentSearchResults = [];
    
    // Diagram types for frontend reference
    const DIAGRAM_TYPES = {
      "flowchart": { name: "Flowchart", icon: "üîÑ" },
      "mindmap": { name: "Mind Map", icon: "üß†" },
      "timeline": { name: "Timeline", icon: "‚è∞" },
      "venn": { name: "Venn Diagram", icon: "‚≠ï" },
      "hierarchy": { name: "Hierarchy Chart", icon: "üèóÔ∏è" },
      "network": { name: "Network Diagram", icon: "üï∏Ô∏è" },
      "comparison": { name: "Comparison Table", icon: "üìä" },
      "custom": { name: "Custom Diagram", icon: "üé®" }
    };

    async function searchPapers() {
      const query = document.getElementById('query').value.trim();
      if (!query) {
        showNotification('Please enter a search term', 'error');
        return;
      }

      // Show loading state
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('results').innerHTML = '';
      document.getElementById('noResults').classList.add('hidden');
      
      // Disable search button
      const searchBtn = document.getElementById('searchBtn');
      searchBtn.disabled = true;
      searchBtn.innerHTML = '<div class="loading w-5 h-5"></div> Searching...';

      try {
        const res = await fetch('/search', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ query: query })
        });
        
        const data = await res.json();
        
        if (data.error) {
          showNotification(data.error, 'error');
          return;
        }

        const papers = data.papers || [];
        currentSearchResults = papers;
        
        if (papers.length === 0) {
          document.getElementById('noResults').classList.remove('hidden');
        } else {
          displayResults(papers);
        }
        
      } catch (error) {
        showNotification('Search failed. Please try again.', 'error');
        console.error('Search error:', error);
      } finally {
        // Hide loading state
        document.getElementById('loading').classList.add('hidden');
        
        // Re-enable search button
        searchBtn.disabled = false;
        searchBtn.innerHTML = '<i class="fas fa-search"></i> Search';
      }
    }

    function displayResults(papers) {
      const results = document.getElementById('results');
      results.innerHTML = '';

      papers.forEach((paper, index) => {
        const card = createPaperCard(paper, index);
        results.appendChild(card);
      });
    }

    function createPaperCard(paper, index) {
      const card = document.createElement('div');
      card.className = 'paper-card glass-card rounded-2xl p-6 shadow-lg';
      
      const authors = (paper.authors && paper.authors.length) ? paper.authors.join(', ') : 'Unknown Authors';
      const hasPDF = paper.download_url || paper.pdf_preview;

      card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
          <div class="flex-1">
            <h3 class="text-xl font-bold text-gray-800 mb-2 leading-tight">${escapeHtml(paper.title || 'No Title')}</h3>
            <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
              <span class="flex items-center gap-1">
                <i class="fas fa-users"></i>
                ${escapeHtml(authors)}
              </span>
              <span class="flex items-center gap-1">
                <i class="fas fa-file-pdf ${hasPDF ? 'text-red-500' : 'text-gray-400'}"></i>
                ${hasPDF ? 'PDF Available' : 'PDF Not Available'}
              </span>
            </div>
          </div>
          <div class="ml-4 flex flex-col gap-2">
            ${paper.download_url ? 
              `<a href="${paper.download_url}" class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                <i class="fas fa-download"></i>
                Open PDF
              </a>` : ''
            }
          </div>
        </div>

        <div class="mb-4">
          <p class="text-gray-700 leading-relaxed">${escapeHtml(paper.abstract || 'No abstract available.')}</p>
        </div>

        ${paper.pdf_preview ? 
          `<div class="mb-4 bg-gray-50 rounded-lg p-2">
            <div class="text-sm text-gray-600 mb-2 flex items-center gap-2">
              <i class="fas fa-eye"></i>
              PDF Preview
            </div>
            <embed src="${paper.pdf_preview}" type="application/pdf" width="100%" height="300px" class="rounded border">
          </div>` : ''
        }

        <div class="flex flex-wrap gap-3 mb-4">
          <button 
            onclick="summarize('${paper.id}', ${index})" 
            class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 transition-all duration-200 shadow-md hover:shadow-lg"
          >
            <i class="fas fa-brain"></i>
            AI Summarize
          </button>
          <button 
            onclick="toggleChat(${index})" 
            class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white rounded-lg hover:from-indigo-700 hover:to-indigo-800 transition-all duration-200 shadow-md hover:shadow-lg"
          >
            <i class="fas fa-comments"></i>
            Chat with Paper
          </button>
          <button 
            onclick="toggleDiagram(${index})" 
            class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:from-purple-700 hover:to-purple-800 transition-all duration-200 shadow-md hover:shadow-lg"
          >
            <i class="fas fa-chart-pie"></i>
            Generate Diagram
          </button>
          <button 
            onclick="generateKnowledgeGraph('${paper.id}', ${index})" 
            class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 shadow-md hover:shadow-lg"
          >
            <i class="fas fa-project-diagram"></i>
            Knowledge Graph
          </button>
          <a 
            href="/3dvis?title=${encodeURIComponent(paper.title || 'Molecule')}" 
            target="_blank"
            class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-teal-600 to-teal-700 text-white rounded-lg hover:from-teal-700 hover:to-teal-800 transition-all duration-200 shadow-md hover:shadow-lg no-underline"
          >
            <i class="fas fa-atom"></i>
            3D Molecule
          </a>
        </div>

        <!-- Summaries Section -->
        <div id="summaries-${index}" class="hidden space-y-4">
          <div class="border-t pt-4">
            <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
              <i class="fas fa-chart-line text-blue-600"></i>
              AI-Generated Summaries
            </h4>
            
            <!-- Progress Indicator -->
            <div id="progress-${index}" class="mb-4 hidden">
              <div class="flex items-center gap-2 mb-2">
                <div class="loading w-4 h-4"></div>
                <span class="text-sm text-gray-600">Generating summaries...</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar-${index}" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
              <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span id="progress-text-${index}">0/4 complete</span>
                <span id="progress-time-${index}">0s</span>
              </div>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-4">
              <button onclick="showTab(${index}, 'scratch')" class="tab-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors" data-tab="scratch">
                <i class="fas fa-graduation-cap mr-2"></i>High School
              </button>
              <button onclick="showTab(${index}, 'undergrad')" class="tab-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors" data-tab="undergrad">
                <i class="fas fa-user-graduate mr-2"></i>Undergraduate
              </button>
              <button onclick="showTab(${index}, 'masters')" class="tab-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors" data-tab="masters">
                <i class="fas fa-user-tie mr-2"></i>Master's
              </button>
              <button onclick="showTab(${index}, 'high')" class="tab-btn px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors" data-tab="high">
                <i class="fas fa-crown mr-2"></i>Expert
              </button>
            </div>
            
            <div id="tab-scratch-${index}" class="tab-content p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400"></div>
            <div id="tab-undergrad-${index}" class="tab-content p-4 bg-green-50 rounded-lg border-l-4 border-green-400"></div>
            <div id="tab-masters-${index}" class="tab-content p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400"></div>
            <div id="tab-high-${index}" class="tab-content p-4 bg-purple-50 rounded-lg border-l-4 border-purple-400"></div>
          </div>
        </div>

        <!-- Chat Section -->
        <div id="chat-card-${index}" class="hidden">
          <div class="border-t pt-4">
            <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
              <i class="fas fa-robot text-indigo-600"></i>
              AI Research Assistant
            </h4>
            
            <div id="chat-box-${index}" class="chat-box mb-4 p-4 bg-gray-50 rounded-lg border min-h-[200px]"></div>
            
            <div class="flex gap-3">
              <input 
                id="chat-input-${index}" 
                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent focus:outline-none" 
                placeholder="Ask a question about this research paper..." 
                onkeypress="if(event.key==='Enter') sendChat('${paper.id}', ${index})"
              />
              <button 
                onclick="sendChat('${paper.id}', ${index})" 
                class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 flex items-center gap-2"
              >
                <i class="fas fa-paper-plane"></i>
                Ask
              </button>
            </div>
            
            <div class="mt-3 text-sm text-gray-600">
              <i class="fas fa-lightbulb mr-2"></i>
              Try asking: "What are the main findings?", "How does this compare to other research?", "What are the limitations?"
            </div>
          </div>
        </div>

        <!-- Diagram Generation Section -->
        <div id="diagram-card-${index}" class="hidden">
          <div class="border-t pt-4">
            <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
              <i class="fas fa-chart-pie text-purple-600"></i>
              AI Diagram Generator
            </h4>
            
            <!-- Diagram Type Selection -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Choose Diagram Type:</label>
              <div id="diagram-types-${index}" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <!-- Diagram types will be loaded here -->
              </div>
            </div>
            
            <!-- Custom Description Input -->
            <div id="custom-description-${index}" class="mb-4 hidden">
              <label class="block text-sm font-medium text-gray-700 mb-2">Custom Description:</label>
              <textarea 
                id="custom-input-${index}"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent focus:outline-none"
                rows="3"
                placeholder="Describe the diagram you want to create..."
              ></textarea>
            </div>
            
            <!-- Generate Button -->
            <div class="mb-4">
              <button 
                onclick="generateDiagram('${paper.id}', ${index})" 
                id="generate-diagram-btn-${index}"
                class="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:from-purple-700 hover:to-purple-800 transition-all duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                <i class="fas fa-magic"></i>
                Generate Diagram
              </button>
            </div>
            
            <!-- Diagram Result -->
            <div id="diagram-result-${index}" class="hidden">
              <div class="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-400">
                <h5 class="font-semibold text-purple-800 mb-2">Generated Diagram:</h5>
                <div id="diagram-content-${index}" class="text-gray-700"></div>
                <div id="diagram-metadata-${index}" class="mt-3 text-sm text-gray-600"></div>
              </div>
            </div>
            
            <!-- Video Generation Button -->
            <div class="mt-6 pt-6 border-t border-gray-200">
              <h4 class="text-lg font-semibold text-gray-800 mb-3">Video Generation</h4>
              <p class="text-sm text-gray-600 mb-4">Create an engaging video summary with voiceover and visuals.</p>
              
              <div class="flex flex-col space-y-4">
                <div class="flex items-center space-x-4">
                  <button 
                    onclick="generateVideo('${paper.id}', ${index})" 
                    id="generate-video-btn-${index}"
                    class="px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 transition-all duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <i class="fas fa-video"></i>
                    Generate Video Summary
                  </button>
                  <div id="video-loading-${index}" class="hidden">
                    <div class="flex items-center space-x-2 text-green-600">
                      <div class="w-5 h-5 border-2 border-green-600 border-t-2 border-t-transparent rounded-full animate-spin"></div>
                      <span>Generating video...</span>
                    </div>
                  </div>
                </div>
                
                <!-- Video Result -->
                <div id="video-result-${index}" class="hidden">
                  <div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-400">
                    <h5 class="font-semibold text-green-800 mb-2">Generated Video:</h5>
                    <div id="video-content-${index}" class="text-gray-700"></div>
                    <div id="video-metadata-${index}" class="mt-3 text-sm text-gray-600"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Loading State -->
            <div id="diagram-loading-${index}" class="hidden text-center py-6">
              <div class="loading mx-auto mb-4"></div>
              <p class="text-purple-600">Generating your diagram...</p>
            </div>
          </div>
        </div>
        
        <!-- Knowledge Graph Modal -->
        <div id="knowledgeGraphModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
          <div class="bg-white rounded-lg w-11/12 h-5/6 flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
              <h3 class="text-xl font-semibold">Research Knowledge Graph</h3>
              <button onclick="document.getElementById('knowledgeGraphModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
              </button>
            </div>
            <div id="graphContainer" class="flex-1 overflow-auto p-4">
              <div id="knowledge-graph" style="width: 100%; height: 100%;"></div>
            </div>
          </div>
        </div>
        
        <style>
          .node {
            cursor: pointer;
          }
          .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 2px;
          }
          .node text {
            font: 12px sans-serif;
          }
          .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
          }
        </style>
        
        </div>
      `;

      return card;
    }

    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    async function summarize(paperId, idx) {
      const container = document.getElementById(`summaries-${idx}`);
      container.classList.remove('hidden');
      
      // Show progress indicator
      const progressDiv = document.getElementById(`progress-${idx}`);
      const progressBar = document.getElementById(`progress-bar-${idx}`);
      const progressText = document.getElementById(`progress-text-${idx}`);
      const progressTime = document.getElementById(`progress-time-${idx}`);
      
      progressDiv.classList.remove('hidden');
      progressBar.style.width = '0%';
      progressText.textContent = '0/4 complete';
      
      // Start timer
      const startTime = Date.now();
      const updateTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        progressTime.textContent = `${elapsed}s`;
      }, 1000);
      
      // Track completion status
      const completedLevels = new Set();
      let totalCompleted = 0;
      
      // Show loading states
      const tabContents = container.querySelectorAll('.tab-content');
      tabContents.forEach(tab => {
        tab.innerHTML = '<div class="flex items-center gap-3"><div class="loading"></div><span>Waiting to start...</span></div>';
      });

      try {
        // Use streaming endpoint for real-time updates
        const eventSource = new EventSource(`/summarize-streaming/${encodeURIComponent(paperId)}`);
        
        eventSource.onmessage = function(event) {
          const data = JSON.parse(event.data);
          
          if (data.level === 'error') {
            // Handle error
            tabContents.forEach(tab => {
              tab.innerHTML = `<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>${data.summary}</div>`;
            });
            eventSource.close();
            clearInterval(updateTimer);
            progressDiv.classList.add('hidden');
            return;
          }
          
          const level = data.level;
          const summary = data.summary;
          const status = data.status;
          
          // Update the appropriate tab
          const tabElement = document.getElementById(`tab-${level}-${idx}`);
          if (tabElement) {
            if (status === 'generating') {
              tabElement.innerHTML = '<div class="flex items-center gap-3"><div class="loading"></div><span>Generating...</span></div>';
            } else if (status === 'complete') {
              tabElement.innerHTML = formatSummary(summary, getLevelDisplayName(level));
              
              // Update progress
              if (!completedLevels.has(level)) {
                completedLevels.add(level);
                totalCompleted++;
                const progressPercent = (totalCompleted / 4) * 100;
                progressBar.style.width = `${progressPercent}%`;
                progressText.textContent = `${totalCompleted}/4 complete`;
                
                // Show success notification for first completed summary
                if (level === 'scratch') {
                  showNotification('First summary ready! More coming...', 'success');
                }
              }
            } else if (status === 'error') {
              tabElement.innerHTML = `<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>${summary}</div>`;
            }
          }
          
          // Close connection when all summaries are complete
          if (status === 'complete' && level === 'high') {
            eventSource.close();
            clearInterval(updateTimer);
            progressDiv.classList.add('hidden');
            
            // Show completion notification
            const totalTime = Math.floor((Date.now() - startTime) / 1000);
            showNotification(`All summaries completed in ${totalTime}s!`, 'success');
            
            // Show first tab by default
            showTab(idx, 'scratch');
          }
        };
        
        eventSource.onerror = function(event) {
          console.error('EventSource failed:', event);
          eventSource.close();
          clearInterval(updateTimer);
          progressDiv.classList.add('hidden');
          
          // Fallback to non-streaming endpoint
          console.log('Falling back to non-streaming endpoint...');
          fallbackSummarize(paperId, idx);
        };
        
      } catch (error) {
        console.error('Streaming failed, falling back:', error);
        clearInterval(updateTimer);
        progressDiv.classList.add('hidden');
        fallbackSummarize(paperId, idx);
      }
    }

    // Fallback function for non-streaming summarization
    async function fallbackSummarize(paperId, idx) {
      try {
        const res = await fetch(`/summarize/${encodeURIComponent(paperId)}`);
        const data = await res.json();
        
        if (data.error) {
          const tabContents = document.querySelectorAll(`#summaries-${idx} .tab-content`);
          tabContents.forEach(tab => {
            tab.innerHTML = `<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>${data.error}</div>`;
          });
          return;
        }

        const summaries = data.summaries || data;
        
        // Update content
        document.getElementById(`tab-scratch-${idx}`).innerHTML = formatSummary(summaries.scratch || summaries['scratch'] || 'N/A', 'High School Level');
        document.getElementById(`tab-undergrad-${idx}`).innerHTML = formatSummary(summaries.undergrad || 'N/A', 'Undergraduate Level');
        document.getElementById(`tab-masters-${idx}`).innerHTML = formatSummary(summaries.masters || 'N/A', 'Master\'s Level');
        document.getElementById(`tab-high-${idx}`).innerHTML = formatSummary(summaries.high || 'N/A', 'Expert Level');

        // Show first tab by default
        showTab(idx, 'scratch');
        
        showNotification('AI summaries generated successfully!', 'success');
        
      } catch (error) {
        const tabContents = document.querySelectorAll(`#summaries-${idx} .tab-content`);
        tabContents.forEach(tab => {
          tab.innerHTML = `<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Failed to generate summary</div>`;
        });
        showNotification('Failed to generate summaries', 'error');
      }
    }

    function formatSummary(content, level) {
      return `
        <div class="mb-2">
          <span class="inline-block px-2 py-1 text-xs font-semibold bg-white rounded-full text-gray-700">${level}</span>
        </div>
        <div class="text-gray-700 leading-relaxed">${content}</div>
      `;
    }

    function showTab(idx, name) {
      // Update tab buttons
      const tabBtns = document.querySelectorAll(`#summaries-${idx} .tab-btn`);
      tabBtns.forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200');
      });
      
      const activeBtn = document.querySelector(`#summaries-${idx} .tab-btn[data-tab="${name}"]`);
      if (activeBtn) {
        activeBtn.classList.remove('bg-gray-200');
        activeBtn.classList.add('bg-blue-600', 'text-white');
      }

      // Show/hide tab content
      ['scratch','undergrad','masters','high'].forEach(n => {
        const el = document.getElementById(`tab-${n}-${idx}`);
        if (el) el.classList.toggle('active', n === name);
      });
    }

    function toggleChat(idx) {
      const card = document.getElementById(`chat-card-${idx}`);
      if (card) {
        card.classList.toggle('hidden');
        
        // Add welcome message if chat is empty
        const chatBox = document.getElementById(`chat-box-${idx}`);
        if (chatBox.children.length === 0) {
          const welcomeDiv = document.createElement('div');
          welcomeDiv.className = 'message bot';
          welcomeDiv.innerHTML = `
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas fa-robot text-white text-sm"></i>
              </div>
              <div>
                <div class="font-semibold text-indigo-600 mb-1">AI Research Assistant</div>
                <div>Hello! I'm here to help you understand this research paper. Ask me anything about the methodology, findings, or implications of this work.</div>
              </div>
            </div>
          `;
          chatBox.appendChild(welcomeDiv);
        }
      }
    }

    function toggleDiagram(idx) {
      const card = document.getElementById(`diagram-card-${idx}`);
      if (card) {
        card.classList.toggle('hidden');
        
        // Load diagram types if not already loaded
        const typesContainer = document.getElementById(`diagram-types-${idx}`);
        if (typesContainer.children.length === 0) {
          loadDiagramTypes(idx);
        }
      }
    }

    async function loadDiagramTypes(idx) {
      try {
        const response = await fetch('/diagram-types');
        const data = await response.json();
        
        if (data.error) {
          showNotification('Failed to load diagram types', 'error');
          return;
        }
        
        const typesContainer = document.getElementById(`diagram-types-${idx}`);
        typesContainer.innerHTML = '';
        
        Object.entries(data.diagram_types).forEach(([type, info]) => {
          const typeDiv = document.createElement('div');
          typeDiv.className = 'diagram-type-option cursor-pointer p-3 border border-gray-200 rounded-lg hover:border-purple-300 hover:bg-purple-50 transition-all duration-200';
          typeDiv.setAttribute('data-type', type);
          typeDiv.innerHTML = `
            <div class="text-center">
              <div class="text-2xl mb-2">${info.icon}</div>
              <div class="font-medium text-gray-800">${info.name}</div>
              <div class="text-xs text-gray-600">${info.description}</div>
            </div>
          `;
          
          typeDiv.addEventListener('click', () => selectDiagramType(idx, type));
          typesContainer.appendChild(typeDiv);
        });
        
        // Enable generate button
        document.getElementById(`generate-diagram-btn-${idx}`).disabled = false;
        
      } catch (error) {
        console.error('Failed to load diagram types:', error);
        showNotification('Failed to load diagram types', 'error');
      }
    }

    function selectDiagramType(idx, type) {
      // Update visual selection
      const allOptions = document.querySelectorAll(`#diagram-types-${idx} .diagram-type-option`);
      allOptions.forEach(option => {
        option.classList.remove('border-purple-500', 'bg-purple-100');
        option.classList.add('border-gray-200');
      });
      
      const selectedOption = document.querySelector(`#diagram-types-${idx} .diagram-type-option[data-type="${type}"]`);
      if (selectedOption) {
        selectedOption.classList.remove('border-gray-200');
        selectedOption.classList.add('border-purple-500', 'bg-purple-100');
      }
      
      // Show/hide custom description input
      const customDiv = document.getElementById(`custom-description-${idx}`);
      if (type === 'custom') {
        customDiv.classList.remove('hidden');
      } else {
        customDiv.classList.add('hidden');
      }
      
      // Store selected type
      window.selectedDiagramType = type;
    }

    async function generateVideo(paperId, idx) {
      // Show loading state
      const loadingDiv = document.getElementById(`video-loading-${idx}`);
      const resultDiv = document.getElementById(`video-result-${idx}`);
      const generateBtn = document.getElementById(`generate-video-btn-${idx}`);
      
      loadingDiv.classList.remove('hidden');
      resultDiv.classList.add('hidden');
      generateBtn.disabled = true;
      
      try {
        // Show processing message
        const contentDiv = document.getElementById(`video-content-${idx}`);
        contentDiv.innerHTML = `
          <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <i class="fas fa-cog fa-spin text-blue-400"></i>
              </div>
              <div class="ml-3">
                <p class="text-sm text-blue-700">Generating video with Gemini Veo 3... This may take a few moments.</p>
                <div class="mt-2 w-full bg-gray-200 rounded-full h-2.5">
                  <div class="bg-blue-600 h-2.5 rounded-full animate-pulse" style="width: 100%"></div>
                </div>
              </div>
            </div>
          </div>
        `;
        resultDiv.classList.remove('hidden');
        
        // Make the API call
        const response = await fetch(`/generate-video/${encodeURIComponent(paperId)}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.error) {
          showNotification(data.error, 'error');
          throw new Error(data.error);
        }
        
        // Display result
        const metadataDiv = document.getElementById(`video-metadata-${idx}`);
        
        if (data.video_url) {
          // Display the generated video with enhanced UI
          contentDiv.innerHTML = `
            <div class="bg-white rounded-lg overflow-hidden shadow-lg">
              <div class="relative pt-[56.25%] bg-black">
                <video 
                  controls 
                  class="absolute top-0 left-0 w-full h-full"
                  poster="${data.thumbnail_url || ''}"
                  preload="metadata"
                >
                  <source src="${data.video_url}" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4">
                  <h3 class="text-white font-semibold text-lg">${data.title || 'Research Video'}</h3>
                  ${data.message ? `<p class="text-sm text-gray-300 mt-1">${data.message}</p>` : ''}
                </div>
              </div>
              ${data.caption ? `
                <div class="p-4 bg-gray-50 border-t border-gray-200">
                  <p class="text-sm text-gray-600">${data.caption}</p>
                </div>
              ` : ''}
            </div>
          `;
          
          // Enhanced metadata display
          metadataDiv.innerHTML = `
            <div class="space-y-2 text-sm">
              <div class="flex items-center">
                <i class="fas fa-clock text-gray-500 w-5"></i>
                <span class="ml-2"><strong>Duration:</strong> ${formatDuration(data.duration || 0)}</span>
              </div>
              <div class="flex items-center">
                <i class="fas fa-expand text-gray-500 w-5"></i>
                <span class="ml-2"><strong>Resolution:</strong> ${data.resolution || '1920x1080'}</span>
              </div>
              <div class="flex items-center">
                <i class="fas fa-film text-gray-500 w-5"></i>
                <span class="ml-2"><strong>Scenes:</strong> ${data.sections || 0}</span>
              </div>
              <div class="flex items-center">
                <i class="fas fa-calendar-alt text-gray-500 w-5"></i>
                <span class="ml-2">${new Date().toLocaleString()}</span>
              </div>
            </div>
          `;
          
          resultDiv.classList.remove('hidden');
          showNotification('Video generated successfully with Gemini Veo 3!', 'success');
          
          // Smooth scroll to the video
          setTimeout(() => {
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 300);
          
        } else if (data.message) {
          // Show processing message
          contentDiv.innerHTML = `
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <i class="fas fa-cog fa-spin text-blue-400"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-blue-700">${data.message}</p>
                  <div class="mt-2 w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-blue-600 h-2.5 rounded-full animate-pulse" style="width: 100%"></div>
                  </div>
                </div>
              </div>
            </div>
          `;
          resultDiv.classList.remove('hidden');
        }
        
      } catch (error) {
        console.error('Video generation failed:', error);
        
        // Show error message
        const contentDiv = document.getElementById(`video-content-${idx}`);
        contentDiv.innerHTML = `
          <div class="bg-red-50 border-l-4 border-red-400 p-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <i class="fas fa-exclamation-circle text-red-400"></i>
              </div>
              <div class="ml-3">
                <p class="text-sm text-red-700">Failed to generate video: ${error.message || 'Unknown error'}</p>
                <button 
                  onclick="generateVideo('${paperId}', ${idx})" 
                  class="mt-2 inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                >
                  <i class="fas fa-redo mr-1"></i> Try Again
                </button>
              </div>
            </div>
          </div>
        `;
        
        resultDiv.classList.remove('hidden');
        showNotification('Failed to generate video: ' + (error.message || 'Unknown error'), 'error');
      } finally {
        // Hide loading state
        loadingDiv.classList.add('hidden');
        generateBtn.disabled = false;
      }
    }

    // Helper function to format duration in seconds to MM:SS
    function formatDuration(seconds) {
      if (!seconds && seconds !== 0) return 'N/A';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    async function generateDiagram(paperId, idx) {
      const selectedType = window.selectedDiagramType;
      if (!selectedType) {
        showNotification('Please select a diagram type first', 'warning');
        return;
      }
      
      let customDescription = '';
      if (selectedType === 'custom') {
        customDescription = document.getElementById(`custom-input-${idx}`).value.trim();
        if (!customDescription) {
          showNotification('Please provide a custom description', 'warning');
          return;
        }
      }
      
      // Show loading state
      const loadingDiv = document.getElementById(`diagram-loading-${idx}`);
      const resultDiv = document.getElementById(`diagram-result-${idx}`);
      const generateBtn = document.getElementById(`generate-diagram-btn-${idx}`);
      
      loadingDiv.classList.remove('hidden');
      resultDiv.classList.add('hidden');
      generateBtn.disabled = true;
      
      try {
        const response = await fetch(`/generate-diagram/${encodeURIComponent(paperId)}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            diagram_type: selectedType,
            custom_description: customDescription
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
          showNotification(data.error, 'error');
          return;
        }
        
        // Display result
        const contentDiv = document.getElementById(`diagram-content-${idx}`);
        const metadataDiv = document.getElementById(`diagram-metadata-${idx}`);
        
        if (data.image_data) {
          // Display the generated image
          contentDiv.innerHTML = `
            <div class="prose max-w-none">
              <h6 class="text-lg font-semibold mb-3">${DIAGRAM_TYPES[selectedType]?.name || 'Custom'} Diagram</h6>
              <div class="bg-white p-4 rounded border text-center">
                <img src="${data.image_data}" alt="Generated Diagram" class="max-w-full h-auto rounded shadow-lg" />
                ${data.caption ? `<p class="mt-3 text-sm text-gray-600 italic">"${data.caption}"</p>` : ''}
              </div>
            </div>
          `;
          
          metadataDiv.innerHTML = `
            <div class="text-xs">
              <strong>Type:</strong> ${data.diagram_type}<br>
              <strong>Model:</strong> ${data.model}<br>
              <strong>Device:</strong> ${data.device}<br>
              <strong>Dimensions:</strong> ${data.dimensions}<br>
              <strong>Generated:</strong> ${new Date().toLocaleString()}
            </div>
          `;
          
          resultDiv.classList.remove('hidden');
          showNotification('Diagram generated successfully!', 'success');
        } else if (data.diagram_description) {
          // Fallback for text-based diagrams
          contentDiv.innerHTML = `
            <div class="prose max-w-none">
              <h6 class="text-lg font-semibold mb-3">${DIAGRAM_TYPES[selectedType]?.name || 'Custom'} Diagram</h6>
              <div class="bg-white p-4 rounded border">
                ${data.diagram_description.replace(/\n/g, '<br>')}
              </div>
            </div>
          `;
          
          metadataDiv.innerHTML = `
            <div class="text-xs">
              <strong>Type:</strong> ${data.diagram_type}<br>
              <strong>Model:</strong> ${data.model}<br>
              <strong>Generated:</strong> ${new Date().toLocaleString()}
            </div>
          `;
          
          resultDiv.classList.remove('hidden');
          showNotification('Diagram generated successfully!', 'success');
        }
        
      } catch (error) {
        console.error('Diagram generation failed:', error);
        showNotification('Failed to generate diagram', 'error');
      } finally {
        // Hide loading state
        loadingDiv.classList.add('hidden');
        generateBtn.disabled = false;
      }
    }

    function generateKnowledgeGraph(paperId, index) {
      const modal = document.getElementById('knowledgeGraphModal');
      const graphContainer = document.getElementById('knowledge-graph');
      
      // Clear previous graph
      graphContainer.innerHTML = '';
      
      // Sample data for the knowledge graph
      const data = {
        nodes: [
          { id: 'paper', name: 'Research Paper', type: 'paper' },
          { id: 'llm', name: 'Large Language Models', type: 'concept' },
          { id: 'nlp', name: 'NLP', type: 'concept' },
          { id: 'transformer', name: 'Transformers', type: 'concept' },
          { id: 'attention', name: 'Attention', type: 'concept' },
          { id: 'fine_tuning', name: 'Fine-tuning', type: 'concept' },
          { id: 'prompting', name: 'Prompting', type: 'concept' },
          { id: 'rlhf', name: 'RLHF', type: 'concept' },
          { id: 'multimodal', name: 'Multimodal', type: 'concept' },
          { id: 'bias', name: 'Bias', type: 'concept' },
          { id: 'ethics', name: 'Ethics', type: 'concept' },
          { id: 'evaluation', name: 'Evaluation', type: 'concept' },
          { id: 'retrieval', name: 'Retrieval', type: 'concept' },
          { id: 'efficiency', name: 'Efficiency', type: 'concept' },
          { id: 'scaling', name: 'Scaling', type: 'concept' },
          { id: 'applications', name: 'Applications', type: 'concept' }
        ],
        links: [
          { source: 'paper', target: 'llm', type: 'main_topic' },
          { source: 'llm', target: 'nlp' },
          { source: 'llm', target: 'transformer' },
          { source: 'transformer', target: 'attention' },
          { source: 'llm', target: 'fine_tuning' },
          { source: 'llm', target: 'prompting' },
          { source: 'llm', target: 'rlhf' },
          { source: 'llm', target: 'multimodal' },
          { source: 'llm', target: 'bias' },
          { source: 'bias', target: 'ethics' },
          { source: 'llm', target: 'evaluation' },
          { source: 'llm', target: 'retrieval' },
          { source: 'llm', target: 'efficiency' },
          { source: 'llm', target: 'scaling' },
          { source: 'llm', target: 'applications' }
        ]
      };
      
      // Create the graph
      createKnowledgeGraph(data);
      
      // Show the modal
      modal.classList.remove('hidden');
      
      // Function to create the D3.js graph
      function createKnowledgeGraph(graphData) {
        const width = graphContainer.clientWidth;
        const height = 600;
        
        // Create SVG
        const svg = d3.select('#knowledge-graph')
          .append('svg')
          .attr('width', '100%')
          .attr('height', height);
          
        // Add zoom behavior
        const zoom = d3.zoom()
          .scaleExtent([0.5, 4])
          .on('zoom', (event) => {
            g.attr('transform', event.transform);
          });
          
        svg.call(zoom);
        
        // Create a group for the graph
        const g = svg.append('g');
        
        // Create a force simulation
        const simulation = d3.forceSimulation(graphData.nodes)
          .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(150))
          .force('charge', d3.forceManyBody().strength(-500))
          .force('center', d3.forceCenter(width / 2, height / 2))
          .force('collision', d3.forceCollide().radius(60));
        
        // Create links
        const link = g.append('g')
          .selectAll('line')
          .data(graphData.links)
          .enter().append('line')
          .attr('class', 'link');
          
        // Create node groups
        const node = g.append('g')
          .selectAll('.node')
          .data(graphData.nodes)
          .enter().append('g')
          .attr('class', 'node')
          .call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended));
          
        // Add circles to nodes
        node.append('circle')
          .attr('r', d => d.type === 'paper' ? 15 : 10)
          .attr('fill', d => d.type === 'paper' ? '#3b82f6' : '#10b981');
          
        // Add text labels
        node.append('text')
          .attr('dy', 4)
          .attr('text-anchor', 'middle')
          .text(d => d.name);
          
        // Update positions on simulation tick
        simulation.on('tick', () => {
          link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);
            
          node.attr('transform', d => `translate(${d.x},${d.y})`);
        });
        
        // Drag functions
        function dragstarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }
        
        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
        }
        
        function dragended(event, d) {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        }
      }
    }
    
    function toggleKnowledgeGraph(index) {
      const modal = document.getElementById(`knowledge-graph-modal-${index}`);
      modal.classList.toggle('hidden');
    }
    
    function renderKnowledgeGraph(container, data, index) {
      // Clear loading state
      container.innerHTML = '';
      
      // Create SVG element
      const width = container.clientWidth;
      const height = 600;
      
      const svg = d3.select(container).append('svg')
        .attr('width', '100%')
        .attr('height', height)
        .attr('viewBox', [0, 0, width, height])
        .attr('style', 'max-width: 100%; height: auto;');
      
      // Add zoom behavior
      const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on('zoom', (event) => {
          g.attr('transform', event.transform);
        });
      
      svg.call(zoom);
      
      // Create a group for the graph
      const g = svg.append('g');
      
      // Process nodes and links
      const nodes = [];
      const links = [];
      
      // Add main paper node
      if (data.paper) {
        nodes.push({
          id: data.paper.id,
          name: data.paper.title || 'Untitled Paper',
          type: 'paper',
          year: data.paper.year,
          citations: data.paper.citations
        });
      }
      
      // Add related papers
      if (data.related_papers && data.related_papers.nodes) {
        data.related_papers.nodes.forEach(node => {
          if (!nodes.find(n => n.id === node.id)) {
            nodes.push({
              ...node,
              type: 'paper'
            });
          }
        });
        
        if (data.related_papers.links) {
          links.push(...data.related_papers.links.map(link => ({
            ...link,
            type: 'cites'
          })));
        }
      }
      
      // Add authors
      if (data.author_network && data.author_network.nodes) {
        data.author_network.nodes.forEach(node => {
          if (!nodes.find(n => n.id === node.id)) {
            nodes.push({
              ...node,
              type: 'author'
            });
          }
        });
        
        if (data.author_network.links) {
          links.push(...data.author_network.links.map(link => ({
            ...link,
            type: 'collaborated_with'
          })));
        }
      }
      
      // Add concepts
      if (data.concept_network && data.concept_network.nodes) {
        data.concept_network.nodes.forEach(node => {
          if (!nodes.find(n => n.id === node.id)) {
            nodes.push({
              ...node,
              type: 'concept'
            });
          }
        });
        
        if (data.concept_network.links) {
          links.push(...data.concept_network.links.map(link => ({
            ...link,
            type: 'mentions'
          })));
        }
      }
      
      // Create the force simulation
      const simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(100))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(40));
      
      // Create links
      const link = g.append('g')
        .selectAll('line')
        .data(links)
        .join('line')
        .attr('stroke', '#999')
        .attr('stroke-opacity', 0.6)
        .attr('stroke-width', 1.5);
      
      // Create node groups
      const node = g.append('g')
        .selectAll('g')
        .data(nodes)
        .join('g')
        .call(drag(simulation));
      
      // Add circles to nodes
      node.append('circle')
        .attr('r', d => {
          if (d.type === 'paper') return 10;
          if (d.type === 'author') return 8;
          return 6;
        })
        .attr('fill', d => {
          switch(d.type) {
            case 'paper': return '#3b82f6';
            case 'author': return '#10b981';
            case 'concept': return '#8b5cf6';
            default: return '#9ca3af';
          }
        })
        .attr('stroke', '#fff')
        .attr('stroke-width', 1.5);
      
      // Add labels
      const labels = node.append('text')
        .text(d => d.name || d.id)
        .attr('font-size', '10px')
        .attr('dx', 12)
        .attr('dy', 4);
      
      // Add tooltips
      const tooltip = d3.select('body').append('div')
        .attr('class', 'fixed bg-gray-900 text-white text-sm px-2 py-1 rounded pointer-events-none opacity-0')
        .style('z-index', '1000');
      
      node.on('mouseover', (event, d) => {
        tooltip.transition()
          .duration(200)
          .style('opacity', 1);
          
        let tooltipHtml = `<div class="font-bold mb-1">${d.name || d.id}</div>`;
        if (d.type === 'paper' && d.year) {
          tooltipHtml += `<div>Year: ${d.year}</div>`;
          if (d.citations) tooltipHtml += `<div>Citations: ${d.citations}</div>`;
        }
        if (d.type === 'author' && d.publications) {
          tooltipHtml += `<div>Publications: ${d.publications}</div>`;
        }
        
        tooltip
          .html(tooltipHtml)
          .style('left', (event.pageX + 10) + 'px')
          .style('top', (event.pageY - 10) + 'px');
      });
      
      node.on('mousemove', (event) => {
        tooltip
          .style('left', (event.pageX + 10) + 'px')
          .style('top', (event.pageY - 10) + 'px');
      });
      
      node.on('mouseout', () => {
        tooltip.transition()
          .duration(500)
          .style('opacity', 0);
      });
      
      // Update positions on simulation tick
      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);
          
      });
    }

    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;
      
      const colors = {
        success: 'bg-green-500 text-white',
        error: 'bg-red-500 text-white',
        info: 'bg-blue-500 text-white',
        warning: 'bg-yellow-500 text-white'
      };
      
      notification.className += ` ${colors[type]}`;
      notification.innerHTML = `
        <div class="flex items-center gap-2">
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Animate in
      setTimeout(() => notification.classList.remove('translate-x-full'), 100);
      
      // Auto remove
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 3000);
    }

    // Chat Functions
    async function sendChat(paperId, idx) {
      const input = document.getElementById(`chat-input-${idx}`);
      const message = input.value.trim();
      
      if (!message) return;
      
      const chatBox = document.getElementById(`chat-box-${idx}`);
      
      // Add user message to chat
      const userMessageDiv = document.createElement('div');
      userMessageDiv.className = 'message user';
      userMessageDiv.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="fas fa-user text-white text-sm"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-white mb-1">You</div>
            <div>${escapeHtml(message)}</div>
          </div>
        </div>
      `;
      chatBox.appendChild(userMessageDiv);
      
      // Clear input
      input.value = '';
      
      // Add loading indicator
      const loadingDiv = document.createElement('div');
      loadingDiv.id = `loading-${Date.now()}`;
      loadingDiv.className = 'message bot';
      loadingDiv.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
            <i class="fas fa-robot text-white text-sm"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-indigo-600 mb-1">AI Research Assistant</div>
            <div class="flex items-center gap-2">
              <div class="loading"></div>
              <span>Thinking...</span>
            </div>
          </div>
        </div>
      `;
      chatBox.appendChild(loadingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
      
      try {
        // Send message to backend
        const response = await fetch(`/chat/${encodeURIComponent(paperId)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            query: message,
            paper_id: paperId
          })
        });
        
        const data = await response.json();
        
        // Remove loading indicator
        chatBox.removeChild(loadingDiv);
        
        // Add bot response
        const botMessageDiv = document.createElement('div');
        botMessageDiv.className = 'message bot';
        botMessageDiv.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
              <i class="fas fa-robot text-white text-sm"></i>
            </div>
            <div class="flex-1">
              <div class="font-semibold text-indigo-600 mb-1">AI Research Assistant</div>
              <div class="text-gray-700">${data.response || 'Sorry, I encountered an error processing your request.'}</div>
              ${data.sources ? `
                <div class="mt-2 text-xs text-gray-500">
                  <div class="font-medium mb-1">Sources:</div>
                  <ul class="space-y-1">
                    ${data.sources.map(source => 
                      `<li class="truncate">${source}</li>`
                    ).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          </div>
        `;
        chatBox.appendChild(botMessageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        
      } catch (error) {
        console.error('Error sending chat message:', error);
        
        // Remove loading indicator
        chatBox.removeChild(loadingDiv);
        
        // Show error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'message bot';
        errorDiv.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0">
              <i class="fas fa-exclamation text-white text-sm"></i>
            </div>
            <div class="flex-1">
              <div class="font-semibold text-red-600 mb-1">Error</div>
              <div>Sorry, I'm having trouble connecting to the server. Please try again later.</div>
            </div>
          </div>
        `;
        chatBox.appendChild(errorDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    // 3D Viewer Functions - Now opens in new tab

    // Knowledge Graph Functions
    // Knowledge graph functionality is now handled by generateKnowledgeGraph
    
    function toggleKnowledgeGraph(index) {
      const modal = document.getElementById(`knowledge-graph-modal-${index}`);
      modal.classList.toggle('hidden');
    }
    
    function renderKnowledgeGraph(container, data, index) {
      // Clear loading state
      container.innerHTML = '';
      
      // Create SVG element
      const width = container.clientWidth;
      const height = 600;
      
      const svg = d3.select(container).append('svg')
        .attr('width', '100%')
        .attr('height', height)
        .attr('viewBox', [0, 0, width, height])
        .attr('style', 'max-width: 100%; height: auto;');
      
      // Add zoom behavior
      const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on('zoom', (event) => {
          g.attr('transform', event.transform);
        });
      
      svg.call(zoom);
      
      // Create a group for the graph
      const g = svg.append('g');
      
      // Process nodes and links
      const nodes = [];
      const links = [];
      
      // Add main paper node
      if (data.paper) {
        nodes.push({
          id: data.paper.id,
          name: data.paper.title || 'Untitled Paper',
          type: 'paper',
          year: data.paper.year,
          citations: data.paper.citations
        });
      }
      
      // Add related papers
      if (data.related_papers && data.related_papers.nodes) {
        data.related_papers.nodes.forEach(node => {
          if (!nodes.find(n => n.id === node.id)) {
            nodes.push({
              ...node,
              type: 'paper'
            });
          }
        });
        
        if (data.related_papers.links) {
          links.push(...data.related_papers.links.map(link => ({
            ...link,
            type: 'cites'
          })));
        }
      }
      
      // Add authors
      if (data.author_network && data.author_network.nodes) {
        data.author_network.nodes.forEach(node => {
          if (!nodes.find(n => n.id === node.id)) {
            nodes.push({
              ...node,
              type: 'author'
            });
          }
        });
        
        if (data.author_network.links) {
          links.push(...data.author_network.links.map(link => ({
            ...link,
            type: 'collaborated_with'
          })));
        }
      }
      
      // Add concepts
      if (data.concept_network && data.concept_network.nodes) {
        data.concept_network.nodes.forEach(node => {
          if (!nodes.find(n => n.id === node.id)) {
            nodes.push({
              ...node,
              type: 'concept'
            });
          }
        });
        
        if (data.concept_network.links) {
          links.push(...data.concept_network.links.map(link => ({
            ...link,
            type: 'mentions'
          })));
        }
      }
      
      // Create the force simulation
      const simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(100))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(40));
      
      // Create links
      const link = g.append('g')
        .selectAll('line')
        .data(links)
        .join('line')
        .attr('stroke', '#999')
        .attr('stroke-opacity', 0.6)
        .attr('stroke-width', 1.5);
      
      // Create node groups
      const node = g.append('g')
        .selectAll('g')
        .data(nodes)
        .join('g')
        .call(drag(simulation));
      
      // Add circles to nodes
      node.append('circle')
        .attr('r', d => {
          if (d.type === 'paper') return 10;
          if (d.type === 'author') return 8;
          return 6;
        })
        .attr('fill', d => {
          switch(d.type) {
            case 'paper': return '#3b82f6';
            case 'author': return '#10b981';
            case 'concept': return '#8b5cf6';
            default: return '#9ca3af';
          }
        })
        .attr('stroke', '#fff')
        .attr('stroke-width', 1.5);
      
      // Add labels
      const labels = node.append('text')
        .text(d => d.name || d.id)
        .attr('font-size', '10px')
        .attr('dx', 12)
        .attr('dy', 4);
      
      // Add tooltips
      const tooltip = d3.select('body').append('div')
        .attr('class', 'fixed bg-gray-900 text-white text-sm px-2 py-1 rounded pointer-events-none opacity-0')
        .style('z-index', '1000');
      
      node.on('mouseover', (event, d) => {
        tooltip.transition()
          .duration(200)
          .style('opacity', 1);
          
        let tooltipHtml = `<div class="font-bold mb-1">${d.name || d.id}</div>`;
        if (d.type === 'paper' && d.year) {
          tooltipHtml += `<div>Year: ${d.year}</div>`;
          if (d.citations) tooltipHtml += `<div>Citations: ${d.citations}</div>`;
        }
        if (d.type === 'author' && d.publications) {
          tooltipHtml += `<div>Publications: ${d.publications}</div>`;
        }
        
        tooltip
          .html(tooltipHtml)
          .style('left', (event.pageX + 10) + 'px')
          .style('top', (event.pageY - 10) + 'px');
      });
      
      node.on('mousemove', (event) => {
        tooltip
          .style('left', (event.pageX + 10) + 'px')
          .style('top', (event.pageY - 10) + 'px');
      });
      
      node.on('mouseout', () => {
        tooltip.transition()
          .duration(500)
          .style('opacity', 0);
      });
      
      // Update positions on simulation tick
      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);
          
        node.attr('transform', d => `translate(${d.x},${d.y})`);
      });
      
      // Drag functions
      function drag(simulation) {
        function dragstarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }
        
        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
        }
        
        function dragended(event, d) {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        }
        
        return d3.drag()
          .on('start', dragstarted)
          .on('drag', dragged)
          .on('end', dragended);
      }
    }
    
    // Initialize with some example searches
    document.addEventListener('DOMContentLoaded', function() {
      // Add some helpful search suggestions
      const suggestions = [
        'machine learning applications',
        'climate change research',
        'quantum computing advances',
        'renewable energy technology',
        'artificial intelligence ethics'
      ];
      
      const queryInput = document.getElementById('query');
      queryInput.addEventListener('focus', function() {
        if (!this.value) {
          this.placeholder = suggestions[Math.floor(Math.random() * suggestions.length)];
        }
      });
    });
  </script>
  <!-- Add D3.js for knowledge graph -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <!-- Knowledge Graph Modal -->
  <div id="knowledgeGraphModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-11/12 h-5/6 flex flex-col">
      <div class="flex justify-between items-center p-4 border-b">
        <h3 class="text-xl font-semibold">Research Knowledge Graph</h3>
        <button onclick="document.getElementById('knowledgeGraphModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      <div id="graphContainer" class="flex-1 overflow-auto p-4">
        <div id="knowledge-graph" style="width: 100%; height: 100%;"></div>
      </div>
    </div>
  </div>
  
  <!-- Add tooltip styles -->
  <style>
    .tooltip {
      position: absolute;
      padding: 0.5rem;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 0.25rem;
      pointer-events: none;
      font-size: 0.875rem;
      max-width: 300px;
      z-index: 1000;
    }
    
    .tooltip div {
      margin: 0.25rem 0;
    }
    
    .tooltip .title {
      font-weight: bold;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 0.25rem;
    }
    
    .tooltip .meta {
      color: #e5e7eb;
      font-size: 0.75rem;
    }
    
    /* Knowledge Graph Styles */
    .node {
      cursor: pointer;
    }
    
    .node circle {
      fill: #fff;
      stroke: #3b82f6;
      stroke-width: 2px;
    }
    
    .node text {
      font: 12px sans-serif;
    }
    
    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }
  </style>
  <!-- 3D Viewer now opens in new tab -->
</body>
</html>
